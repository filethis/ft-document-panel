<!--
Copyright 2017 FileThis, Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->


<link rel="import" href="../ft-confirmation-dialog/ft-confirmation-dialog.html">
<link rel="import" href="../ft-document-grid/ft-document-grid.html">
<link rel="import" href="../ft-document-list/ft-document-list.html">
<link rel="import" href="../ft-labeled-icon-button/ft-labeled-icon-button.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../shadycss/apply-shim.html">

<!--
`<ft-document-panel>`

This element displays a list of FileThis document resources. Above the list is a header area that can display a title and several buttons that affect how the document items are displayed, or operate on the selected documents. Which header elements are displayed is configurable.

@demo
-->
<dom-module id="ft-document-panel">

    <template>

        <style include="iron-flex iron-flex-alignment iron-positioning"></style>

        <style>
            :host {
                display:block;
                overflow:hidden;
                @apply --layout-vertical;
                @apply --ft-document-panel;
            }
        </style>

        <!-- Button bar -->
        <div
                id="buttonBar"
                class="layout horizontal center"
                hidden$="[[!_showButtonBar]]"
                style="height:60px; padding-left:16px; padding-right:15px; border-bottom:1px solid #DDD;">

            <!-- Title -->
            <iron-label
                    hidden$="[[!showTitle]]"
                    style="font-family:Arial; font-size:14pt; ">
                [[title]]
            </iron-label>

            <!-- Title spacer -->
            <div style$=width:[[_titleSpacerWidth]]px;"></div>

            <!-- Grid button -->
            <ft-labeled-icon-button
                    id="defaultServerButton"
                    icon="apps"
                    label="Grid"
                    hidden$="[[!showGridButton]]"
                    style$="margin-right:5px;"
                    on-tap="_onViewAsGridButtonClicked">
            </ft-labeled-icon-button>

            <!-- List button -->
            <ft-labeled-icon-button
                    id="listButton"
                    icon="view-headline"
                    label="List"
                    hidden$="[[!showListButton]]"
                    style$="margin-right:5px;"
                    on-tap="_onViewAsListButtonClicked">
            </ft-labeled-icon-button>

            <!-- Preview button -->
            <ft-labeled-icon-button
                    id="previewButton"
                    icon="visibility"
                    label="Preview"
                    disabled="[[!_haveSelection]]"
                    hidden$="[[!showPreviewButton]]"
                    style$="margin-right:5px;"
                    on-tap="_onPreviewButtonClicked">
            </ft-labeled-icon-button>

            <!-- View button group spacer -->
            <div style$=width:[[_viewButtonGroupSpacerWidth]]px;"></div>

            <!-- Upload button -->
            <ft-labeled-icon-button
                    id="uploadButton"
                    icon="file-upload"
                    label="Upload"
                    hidden$="[[!showUploadButton]]"
                    style$="margin-right:5px;"
                    on-tap="_onUploadButtonClicked">
            </ft-labeled-icon-button>

            <!-- Download button -->
            <ft-labeled-icon-button
                    id="downloadButton"
                    icon="file-download"
                    label="Down"
                    disabled="[[!_haveSelection]]"
                    hidden$="[[!showDownloadButton]]"
                    style$="margin-right:5px;"
                    on-tap="_onDownloadButtonClicked">
            </ft-labeled-icon-button>

            <!-- Upload/download button group spacer -->
            <div style$=width:[[_uploadDownloadButtonGroupSpacerWidth]]px;"></div>

            <!-- Delete button -->
            <ft-labeled-icon-button
                    id="deleteButton"
                    icon="delete"
                    label="Delete"
                    disabled="[[!_haveSelection]]"
                    hidden$="[[!showDeleteButton]]"
                    style$="margin-right:5px;"
                    on-tap="_onDeleteButtonClicked">
            </ft-labeled-icon-button>

            <!-- Upload/download button group spacer -->
            <div style$=width:20px;"></div>

            <!-- Document count -->
            <iron-label
                    id="documentCount"
                    hidden$="[[!showDocumentCount]]"
                    style="font-family:Arial; font-size:14pt; ">
                [[documentCount]]
            </iron-label>

            <div class="flex"></div>
            <div style="width:25px;"></div>

            <!-- Details button -->
            <!--<ft-labeled-icon-button-->
                    <!--id="detailsButton"-->
                    <!--icon="info-outline"-->
                    <!--label="Details"-->
                    <!--disabled="[[!_haveSelection]]"-->
                    <!--on-tap="_onShowDetailsButtonClicked">-->
            <!--</ft-labeled-icon-button>-->
        </div>

        <!-- Views -->
        <iron-pages
                id="views"
                class="flex"
                style="background-color:white; "
                attr-for-selected="id"
                selected="[[selectedView]]">

            <!-- Grid -->
            <ft-document-grid
                    id="grid"
                    style="width:100%; height:100%; "
                    documents="[[documents]]"
                    selected-document="{{selectedDocument}}">
            </ft-document-grid>

            <!-- List -->
            <ft-document-list
                    id="list"
                    style="width:100%; height:100%; "
                    documents="[[documents]]"
                    selected-document="{{selectedDocument}}">
            </ft-document-list>

            <!-- Preview -->
            <div
                    id="preview"
                    class="layout vertical center"
                    style="width:100%; height:100%; ">

                <div style="height:100px;"></div>

                <iron-label style="font-size:24pt">
                    Document preview is coming soon
                </iron-label>

                <div style="height:100px;"></div>
            </div>

        </iron-pages>

        <!-- Confirmation dialog -->
        <ft-confirmation-dialog id="confirmationDialog"></ft-confirmation-dialog>

    </template>

    <script>
        Polymer({

            is: 'ft-document-panel',

            /**
             * Fired when the "Download" button is clicked.
             *
             * @event download
             * @param {Object} document The selected document whose file the user wants to download.
             */

            /**
             * Fired when the "Upload" button is clicked.
             *
             * @event upload
             */

            /**
             * Fired when the "Delete" button is clicked.
             *
             * @event delete
             * @param {Object} document The selected document to be deleted.
             */

            /**
             * Fired when the "Show Details" button is clicked.
             *
             * @event show-details
             */

            observers:
            [
                "_onConfigPropertyChanged(showTitle, title, showGridButton, showListButton, showPreviewButton, showUploadButton, showDownloadButton, showDeleteButton, showDocumentCount)"
            ],

            properties: {

                /** The list of documents resources to be displayed. */
                documents:
                {
                    type: Array,
                    notify: true,
                    value: [],
                    observer: "_documentsChanged"
                },

                /** The currently-selected document, if any. */
                selectedDocument:
                {
                    type: Object,
                    notify: true,
                    value: null,
                    observer: "_selectedDocumentChanged"
                },

                /** The total number of documents. */
                documentCount:
                {
                    type: Number,
                    notify: true,
                    value: 0
                },

                /**
                 * Show a title string.
                 *
                 * Note that you can provide the strings "true" and "false" as attribute values .
                 *
                 * @type {boolean}
                 */
                showTitle:
                {
                    type: Object,
                    value: true
                },

                /** Title to display when "showTitle" is true. */
                title:
                {
                    type: String,
                    value: "Documents"
                },

                /** The currently-selected view of the document(s). Must be one of: "grid", "list", "preview". */
                selectedView:
                {
                    type: String,
                    notify: true,
                    value: "grid"
                },

                /**
                 * Show a button that lets users choose to view documents in a grid.
                 *
                 * Note that you can provide the strings "true" and "false" as attribute values .
                 *
                 * @type {boolean}
                 */
                showGridButton:
                {
                    type: Object,
                    value: true
                },

                /**
                 * Show a button that lets users choose to view documents in a list.
                 *
                 * Note that you can provide the strings "true" and "false" as attribute values .
                 *
                 * @type {boolean}
                 */
                showListButton:
                {
                    type: Object,
                    value: true
                },

                /**
                 * Show a button that lets users choose to preview the selected document.
                 *
                 * Note that you can provide the strings "true" and "false" as attribute values .
                 *
                 * @type {boolean}
                 */
                showPreviewButton:
                {
                    type: Object,
                    value: true
                },

                /**
                 * Show a button that lets users upload document files.
                 *
                 * Note that you can provide the strings "true" and "false" as attribute values .
                 *
                 * @type {boolean}
                 */
                showUploadButton:
                {
                    type: Object,
                    value: true
                },

                /**
                 * Show a button that lets users download file for the selected document.
                 *
                 * Note that you can provide the strings "true" and "false" as attribute values .
                 *
                 * @type {boolean}
                 */
                showDownloadButton:
                {
                    type: Object,
                    value: true
                },

                /**
                 * Show a button that lets users delete the selected document.
                 *
                 * Note that you can provide the strings "true" and "false" as attribute values .
                 *
                 * @type {boolean}
                 */
                showDeleteButton:
                {
                    type: Object,
                    value: true
                },

                /**
                 * Show count of documents.
                 *
                 * Note that you can provide the strings "true" and "false" as attribute values .
                 *
                 * @type {boolean}
                 */
                showDocumentCount:
                {
                    type: Object,
                    value: true
                },

                /** The FileThis ticket. Used for uploads. */
                ticket:
                {
                    type: String,
                    value: ""
                },

                /** True when at least one of the header widgets is displayed. When false, the header is hidden. */
                _showButtonBar:
                {
                    type: Boolean,
                    value: true
                },

                /** Horizontal space to use between the title and any buttons that follow to the right. */
                _titleSpacerWidth:
                {
                    type: Number,
                    value: 30
                },

                /** Horizontal space to use between the last view-type button and any buttons that follow to the right. */
                _viewButtonGroupSpacerWidth:
                {
                    type: Number,
                    value: 30
                },

                /** Horizontal space to use between the last upload/download button and any buttons that follow to the right. */
                _uploadDownloadButtonGroupSpacerWidth:
                {
                    type: Number,
                    value: 30
                },

                /** True if any document is selected. Used to enable/disable buttons that can operate on a selection. */
                _haveSelection:
                {
                    type: Boolean,
                    value: false
                },

                /** The instantiation code. */
                code: {
                    type: String,
                    notify: true,
                    value: ""
                }

            },

            _documentsChanged: function(to, from)
            {
                // Man, this is fugly...
                // TODO: This can probably be replaced by a resize message sent to the iron-pages
                this._fixGrid();
//                this.$.documentGrid.fire('resize');
//                this.$.documentList.fire('resize');

                var documentCount = 0;
                if (!!this.documents)
                    documentCount = this.documents.length;
                this.documentCount = documentCount;
            },

            _fixGrid: function()
            {
                var currentSelectedViewId = this.selectedView;
                var tempSelectedViewId;
                if (currentSelectedViewId === "list")
                    tempSelectedViewId = "grid";
                else // currentSelectedViewId === "grid"
                    tempSelectedViewId = "list";
                this.selectedView = tempSelectedViewId;
                this.selectedView = currentSelectedViewId;
            },

            _selectedDocumentChanged: function(to, from)
            {
                this._haveSelection = (this.selectedDocument !== null);
            },

            _onViewAsListButtonClicked: function(event)
            {
                this.selectedView = "list";
            },

            _onViewAsGridButtonClicked: function(event)
            {
                this.selectedView = "grid";
            },

            _onPreviewButtonClicked: function(event)
            {
                this.selectedView = "preview";
            },

            _onDownloadButtonClicked: function(event)
            {
                this.fire('download', this.selectedDocument);
            },

            _onUploadButtonClicked: function(event)
            {
                this.fire('upload');
            },

            _onDeleteButtonClicked: function(event)
            {
                var overrideWarning = event.metaKey;
                if (overrideWarning)
                {
                    this.fire('delete', this.selectedDocument);
                    return;
                }

                var prompt = "Are you sure you want to delete the selected document?";
                return this.$.confirmationDialog.confirm(prompt, "Delete Document")
                    .then(function(choice)
                    {
                        if (choice === "cancel")
                            return;
                        this.fire('delete', this.selectedDocument);
                    }.bind(this))
            },

            _onShowDetailsButtonClicked: function(event)
            {
                this.fire('show-details');
            },

            _showButtonChanged: function()
            {
                this._showButtonBar = this._canShowButtonBar();
                this._respaceButtons();
            },

            _canShowButtonBar: function()
            {
                if (this.showTitle)
                    return true;
                if (this._someViewButtonShown())
                    return true;
                if (this._someUploadDownloadButtonShown())
                    return true;
                if (this.showDeleteButton)
                    return true;
                if (this.showDocumentCount)
                    return true;
                return false;
            },

            _someViewButtonShown: function()
            {
                if (this.showGridButton)
                    return true;
                if (this.showListButton)
                    return true;
                if (this.showPreviewButton)
                    return true;
                return false;
            },

            _someUploadDownloadButtonShown: function()
            {
                if (this.showUploadButton)
                    return true;
                if (this.showDownloadButton)
                    return true;
                return false;
            },

            _respaceButtons: function()
            {
                var groupSpacerWidth = 30;

                var titleSpacerWidth = 0;
                var viewButtonGroupSpacerWidth = 0;
                var uploadDownloadButtonGroupSpacerWidth = 0;

                if (this.showTitle)
                    titleSpacerWidth = groupSpacerWidth;
                if (this._someViewButtonShown())
                    viewButtonGroupSpacerWidth = groupSpacerWidth;
                if (this._someUploadDownloadButtonShown())
                    uploadDownloadButtonGroupSpacerWidth = groupSpacerWidth;

                this._titleSpacerWidth = titleSpacerWidth;
                this._viewButtonGroupSpacerWidth = viewButtonGroupSpacerWidth;
                this._uploadDownloadButtonGroupSpacerWidth = uploadDownloadButtonGroupSpacerWidth;
            },

            _onConfigPropertyChanged: function(to, from)
            {
                this._configPropertyChangedDebouncer = Polymer.Debouncer.debounce
                (
                    this._configPropertyChangedDebouncer,
                    Polymer.Async.timeOut.after(60),
                    this._onConfigPropertyChangedDebounced.bind(this)
                );
            },

            _onConfigPropertyChangedDebounced: function()
            {
                this._showButtonChanged();

                var code =
                    "<{{name}}\n" +
                    "    showTitle='{{showTitle}}'\n" +
                    "    title='{{title}}'\n" +
                    "    showGridButton='{{showGridButton}}'\n" +
                    "    showListButton='{{showListButton}}'\n" +
                    "    showPreviewButton='{{showPreviewButton}}'\n" +
                    "    showUploadButton='{{showUploadButton}}'\n" +
                    "    showDownloadButton='{{showDownloadButton}}'\n" +
                    "    showDeleteButton='{{showDeleteButton}}'\n" +
                    "    showDocumentCount='{{showDocumentCount}}'>\n" +
                    "</{{name}}>";
                code = code.replace(/{{name}}/g, this.localName);
                code = code.replace(/{{showTitle}}/g, this.showTitle);
                code = code.replace(/{{title}}/g, this.title);
                code = code.replace(/{{showGridButton}}/g, this.showGridButton);
                code = code.replace(/{{showListButton}}/g, this.showListButton);
                code = code.replace(/{{showPreviewButton}}/g, this.showPreviewButton);
                code = code.replace(/{{showUploadButton}}/g, this.showUploadButton);
                code = code.replace(/{{showDownloadButton}}/g, this.showDownloadButton);
                code = code.replace(/{{showDeleteButton}}/g, this.showDeleteButton);
                code = code.replace(/{{showDocumentCount}}/g, this.showDocumentCount);
                this.code = code;
            }

        });
    </script>
</dom-module>
