<!--
Copyright 2017 FileThis, Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->


<link rel="import" href="../ft-confirmation-dialog/ft-confirmation-dialog.html">
<link rel="import" href="../ft-document-grid/ft-document-grid.html">
<link rel="import" href="../ft-document-list/ft-document-list.html">
<link rel="import" href="../ft-global-variable/ft-global-variable.html">
<link rel="import" href="../ft-labeled-icon-button/ft-labeled-icon-button.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../shadycss/apply-shim.html">
<link rel="import" href="ft-document-panel-settings-behavior.html">

<!--
`<ft-document-panel>`

This element displays a list of FileThis document resources. Above the list is a header area that can display a title and several buttons that affect how the document items are displayed, or operate on the selected documents. Which header elements are displayed is configurable.

@demo
-->
<dom-module id="ft-document-panel">

    <template>

        <style include="iron-flex iron-flex-alignment iron-positioning"></style>

        <style>
            :host {
                display:block;
                overflow:hidden;
                @apply --layout-vertical;
                @apply --ft-document-panel;
            }
        </style>

        <!-- Settings -->
        <ft-global-variable name="ft-document-panel-showHeading" value="{{showHeading}}"></ft-global-variable>
        <ft-global-variable name="ft-document-panel-heading" value="{{heading}}"></ft-global-variable>
        <ft-global-variable name="ft-document-panel-show-grid-button" value="{{showGridButton}}"></ft-global-variable>
        <ft-global-variable name="ft-document-panel-show-list-button" value="{{showListButton}}"></ft-global-variable>
        <ft-global-variable name="ft-document-panel-show-preview-button" value="{{showPreviewButton}}"></ft-global-variable>
        <ft-global-variable name="ft-document-panel-show-upload-button" value="{{showUploadButton}}"></ft-global-variable>
        <ft-global-variable name="ft-document-panel-show-download-button" value="{{showDownloadButton}}"></ft-global-variable>
        <ft-global-variable name="ft-document-panel-show-delete-button" value="{{showDeleteButton}}"></ft-global-variable>
        <ft-global-variable name="ft-document-panel-show-document-count" value="{{showDocumentCount}}"></ft-global-variable>

        <!-- Button bar -->
        <div
                id="buttonBar"
                class="layout horizontal center"
                hidden$="[[!_showButtonBar]]"
                style="height:60px; padding-left:16px; padding-right:15px; border-bottom:1px solid #DDD;">

            <!-- Heading -->
            <iron-label
                    hidden$="[[!showHeading]]"
                    style="font-family:Arial; font-size:14pt; ">
                [[heading]]
            </iron-label>

            <!-- Heading spacer -->
            <div style$=width:[[_headingSpacerWidth]]px;"></div>

            <!-- Grid button -->
            <ft-labeled-icon-button
                    id="defaultServerButton"
                    icon="apps"
                    label="Grid"
                    hidden$="[[!showGridButton]]"
                    style$="margin-right:5px;"
                    on-tap="_onViewAsGridButtonClicked">
            </ft-labeled-icon-button>

            <!-- List button -->
            <ft-labeled-icon-button
                    id="listButton"
                    icon="view-headline"
                    label="List"
                    hidden$="[[!showListButton]]"
                    style$="margin-right:5px;"
                    on-tap="_onViewAsListButtonClicked">
            </ft-labeled-icon-button>

            <!-- Preview button -->
            <ft-labeled-icon-button
                    id="previewButton"
                    icon="visibility"
                    label="Preview"
                    disabled="[[!_haveSelection]]"
                    hidden$="[[!showPreviewButton]]"
                    style$="margin-right:5px;"
                    on-tap="_onPreviewButtonClicked">
            </ft-labeled-icon-button>

            <!-- View button group spacer -->
            <div style$=width:[[_viewButtonGroupSpacerWidth]]px;"></div>

            <!-- Upload button -->
            <ft-labeled-icon-button
                    id="uploadButton"
                    icon="file-upload"
                    label="Upload"
                    hidden$="[[!showUploadButton]]"
                    style$="margin-right:5px;"
                    on-tap="_onUploadButtonClicked">
            </ft-labeled-icon-button>

            <!-- Download button -->
            <ft-labeled-icon-button
                    id="downloadButton"
                    icon="file-download"
                    label="Down"
                    disabled="[[!_haveSelection]]"
                    hidden$="[[!showDownloadButton]]"
                    style$="margin-right:5px;"
                    on-tap="_onDownloadButtonClicked">
            </ft-labeled-icon-button>

            <!-- Upload/download button group spacer -->
            <div style$=width:[[_uploadDownloadButtonGroupSpacerWidth]]px;"></div>

            <!-- Delete button -->
            <ft-labeled-icon-button
                    id="deleteButton"
                    icon="delete"
                    label="Delete"
                    disabled="[[!_haveSelection]]"
                    hidden$="[[!showDeleteButton]]"
                    style$="margin-right:5px;"
                    on-tap="_onDeleteButtonClicked">
            </ft-labeled-icon-button>

            <!-- Upload/download button group spacer -->
            <div style$=width:20px;"></div>

            <!-- Document count -->
            <iron-label
                    id="documentCount"
                    hidden$="[[!showDocumentCount]]"
                    style="font-family:Arial; font-size:14pt; ">
                [[documentCount]]
            </iron-label>

            <div class="flex"></div>
            <div style="width:25px;"></div>

            <!-- Details button -->
            <!--<ft-labeled-icon-button-->
                    <!--id="detailsButton"-->
                    <!--icon="info-outline"-->
                    <!--label="Details"-->
                    <!--disabled="[[!_haveSelection]]"-->
                    <!--on-tap="_onShowDetailsButtonClicked">-->
            <!--</ft-labeled-icon-button>-->
        </div>

        <!-- Views -->
        <iron-pages
                id="views"
                class="flex layout vertical"
                style="background-color:white; "
                attr-for-selected="id"
                selected="[[selectedView]]">

            <!-- Grid -->
            <ft-document-grid
                    id="grid"
                    class="flex"
                    documents="[[documents]]"
                    selected-document="{{selectedDocument}}">
            </ft-document-grid>

            <!-- List -->
            <ft-document-list
                    id="list"
                    class="flex"
                    documents="[[documents]]"
                    selected-document="{{selectedDocument}}">
            </ft-document-list>

            <!-- Preview -->
            <div
                    id="preview"
                    class="flex layout vertical center">

                <div style="height:100px;"></div>

                <iron-label style="font-size:24pt">
                    Document preview is coming soon
                </iron-label>

                <div style="height:100px;"></div>
            </div>

        </iron-pages>

        <!-- Confirmation dialog -->
        <ft-confirmation-dialog id="confirmationDialog"></ft-confirmation-dialog>

    </template>

    <script>
        Polymer({

            is: 'ft-document-panel',

            /**
             * Fired when the "Download" button is clicked.
             *
             * @event download
             * @param {Object} document The selected document whose file the user wants to download.
             */

            /**
             * Fired when the "Upload" button is clicked.
             *
             * @event upload
             */

            /**
             * Fired when the "Delete" button is clicked.
             *
             * @event delete
             * @param {Object} document The selected document to be deleted.
             */

            /**
             * Fired when the "Show Details" button is clicked.
             *
             * @event show-details
             */

            behaviors: [FileThis.DocumentPanelSettingsBehavior],

            observers:
            [
                "_onSettingsPropertyChanged(showHeading, heading, showGridButton, showListButton, showPreviewButton, showUploadButton, showDownloadButton, showDeleteButton, showDocumentCount)"
            ],

            properties: {

                /** The list of documents resources to be displayed. */
                documents:
                {
                    type: Array,
                    notify: true,
                    value: [],
                    observer: "_documentsChanged"
                },

                /** The currently-selected document, if any. */
                selectedDocument:
                {
                    type: Object,
                    notify: true,
                    value: null,
                    observer: "_selectedDocumentChanged"
                },

                /** The total number of documents. */
                documentCount:
                {
                    type: Number,
                    notify: true,
                    value: 0
                },

                /** The currently-selected view of the document(s). Must be one of: "grid", "list", "preview". */
                selectedView:
                {
                    type: String,
                    notify: true,
                    value: "grid"
                },

                /** The FileThis ticket. Used for uploads. */
                ticket:
                {
                    type: String,
                    value: ""
                },

                /** True when at least one of the header widgets is displayed. When false, the header is hidden. */
                _showButtonBar:
                {
                    type: Boolean,
                    value: true
                },

                /** Horizontal space to use between the heading and any buttons that follow to the right. */
                _headingSpacerWidth:
                {
                    type: Number,
                    value: 30
                },

                /** Horizontal space to use between the last view-type button and any buttons that follow to the right. */
                _viewButtonGroupSpacerWidth:
                {
                    type: Number,
                    value: 30
                },

                /** Horizontal space to use between the last upload/download button and any buttons that follow to the right. */
                _uploadDownloadButtonGroupSpacerWidth:
                {
                    type: Number,
                    value: 30
                },

                /** True if any document is selected. Used to enable/disable buttons that can operate on a selection. */
                _haveSelection:
                {
                    type: Boolean,
                    value: false
                },

            },

            _documentsChanged: function(to, from)
            {
                // Man, this is fugly...
                // TODO: This can probably be replaced by a resize message sent to the iron-pages
                this._fixGrid();
//                this.$.documentGrid.fire('resize');
//                this.$.documentList.fire('resize');

                var documentCount = 0;
                if (!!this.documents)
                    documentCount = this.documents.length;
                this.documentCount = documentCount;
            },

            _fixGrid: function()
            {
                var currentSelectedViewId = this.selectedView;
                var tempSelectedViewId;
                if (currentSelectedViewId === "list")
                    tempSelectedViewId = "grid";
                else // currentSelectedViewId === "grid"
                    tempSelectedViewId = "list";
                this.selectedView = tempSelectedViewId;
                this.selectedView = currentSelectedViewId;
            },

            _selectedDocumentChanged: function(to, from)
            {
                this._haveSelection = (this.selectedDocument !== null);
            },

            _onViewAsListButtonClicked: function(event)
            {
                this.selectedView = "list";
            },

            _onViewAsGridButtonClicked: function(event)
            {
                this.selectedView = "grid";
            },

            _onPreviewButtonClicked: function(event)
            {
                this.selectedView = "preview";
            },

            _onDownloadButtonClicked: function(event)
            {
                this.fire('download-documents-command', this.selectedDocument);
            },

            _onUploadButtonClicked: function(event)
            {
                this.fire('upload-documents-command');
            },

            _onDeleteButtonClicked: function(event)
            {
                var overrideWarning = event.metaKey;
                if (overrideWarning)
                {
                    this.fire('delete-document-command', this.selectedDocument);
                    return;
                }

                var prompt = "Are you sure you want to delete the selected document?";
                return this.$.confirmationDialog.confirm(prompt, "Delete Document")
                    .then(function(choice)
                    {
                        if (choice === "cancel")
                            return;
                        this.fire('delete-document-command', this.selectedDocument);
                    }.bind(this))
            },

            _onShowDetailsButtonClicked: function(event)
            {
                this.fire('show-details-command');
            },

            _showButtonChanged: function()
            {
                this._showButtonBar = this._canShowButtonBar();
                this._respaceButtons();
            },

            _canShowButtonBar: function()
            {
                if (this.showHeading)
                    return true;
                if (this._someViewButtonShown())
                    return true;
                if (this._someUploadDownloadButtonShown())
                    return true;
                if (this.showDeleteButton)
                    return true;
                if (this.showDocumentCount)
                    return true;
                return false;
            },

            _someViewButtonShown: function()
            {
                if (this.showGridButton)
                    return true;
                if (this.showListButton)
                    return true;
                if (this.showPreviewButton)
                    return true;
                return false;
            },

            _someUploadDownloadButtonShown: function()
            {
                if (this.showUploadButton)
                    return true;
                if (this.showDownloadButton)
                    return true;
                return false;
            },

            _respaceButtons: function()
            {
                var groupSpacerWidth = 30;

                var headingSpacerWidth = 0;
                var viewButtonGroupSpacerWidth = 0;
                var uploadDownloadButtonGroupSpacerWidth = 0;

                if (this.showHeading)
                    headingSpacerWidth = groupSpacerWidth;
                if (this._someViewButtonShown())
                    viewButtonGroupSpacerWidth = groupSpacerWidth;
                if (this._someUploadDownloadButtonShown())
                    uploadDownloadButtonGroupSpacerWidth = groupSpacerWidth;

                this._headingSpacerWidth = headingSpacerWidth;
                this._viewButtonGroupSpacerWidth = viewButtonGroupSpacerWidth;
                this._uploadDownloadButtonGroupSpacerWidth = uploadDownloadButtonGroupSpacerWidth;
            },

            _onSettingsPropertyChanged: function()
            {
                this._showButtonChanged();

                this.fire("settings-property-changed");
            },

        });
    </script>
</dom-module>
