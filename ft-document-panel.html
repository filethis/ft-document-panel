<!--
Copyright 2017 FileThis, Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->


<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-pages/iron-pages.html">

<link rel="import" href="../ft-document-list/ft-document-list.html">
<link rel="import" href="../ft-document-grid/ft-document-grid.html">
<link rel="import" href="../ft-labeled-icon-button/ft-labeled-icon-button.html">
<link rel="import" href="../ft-confirmation-dialog/ft-confirmation-dialog.html">
<link rel="import" href="../ft-scrolling-behavior/ft-scrolling-behavior.html">


<!--
`ft-document-panel`
A panel that displays a list of FileThis documents

@demo demo/index.html
-->

<dom-module id="ft-document-panel">

    <template>

        <style include="iron-flex iron-flex-alignment iron-positioning"></style>

        <style>
            :host {
                display:block;
            }
        </style>

        <div class="layout vertical">

            <!-- Button bar -->
            <div
                    id="buttonBar"
                    class="layout horizontal center"
                    hidden$="[[!_showButtonBar]]"
                    style="height:60px; padding-left:16px; padding-right:15px; border-bottom:1px solid #DDD;">

                <!-- Title -->
                <iron-label
                        hidden$="[[!showTitle]]"
                        style="font-family:Arial; font-size:14pt; ">
                    [[title]]
                </iron-label>

                <!-- Title spacer -->
                <div style$=width:[[_titleSpacerWidth]]px;"></div>

                <!-- Grid button -->
                <ft-labeled-icon-button
                        id="defaultServerButton"
                        icon="apps"
                        label="Grid"
                        hidden$="[[!showGridButton]]"
                        style$="margin-right:5px;"
                        on-tap="_onViewAsGridButtonClicked">
                </ft-labeled-icon-button>

                <!-- List button -->
                <ft-labeled-icon-button
                        id="listButton"
                        icon="view-headline"
                        label="List"
                        hidden$="[[!showListButton]]"
                        style$="margin-right:5px;"
                        on-tap="_onViewAsListButtonClicked">
                </ft-labeled-icon-button>

                <!-- Preview button -->
                <ft-labeled-icon-button
                        id="previewButton"
                        icon="visibility"
                        label="Preview"
                        disabled="[[!_haveSelection]]"
                        hidden$="[[!showPreviewButton]]"
                        style$="margin-right:5px;"
                        on-tap="_onPreviewButtonClicked">
                </ft-labeled-icon-button>

                <!-- View button group spacer -->
                <div style$=width:[[_viewButtonGroupSpacerWidth]]px;"></div>

                <!-- Upload button -->
                <ft-labeled-icon-button
                        id="uploadButton"
                        icon="file-upload"
                        label="Upload"
                        hidden$="[[!showUploadButton]]"
                        style$="margin-right:5px;"
                        on-tap="_onUploadButtonClicked">
                </ft-labeled-icon-button>

                <!-- Download button -->
                <ft-labeled-icon-button
                        id="downloadButton"
                        icon="file-download"
                        label="Down"
                        disabled="[[!_haveSelection]]"
                        hidden$="[[!showDownloadButton]]"
                        style$="margin-right:5px;"
                        on-tap="_onDownloadButtonClicked">
                </ft-labeled-icon-button>

                <!-- Upload/download button group spacer -->
                <div style$=width:[[_uploadDownloadButtonGroupSpacerWidth]]px;"></div>

                <!-- Delete button -->
                <ft-labeled-icon-button
                        id="deleteButton"
                        icon="delete"
                        label="Delete"
                        disabled="[[!_haveSelection]]"
                        hidden$="[[!showDeleteButton]]"
                        style$="margin-right:5px;"
                        on-tap="_onDeleteButtonClicked">
                </ft-labeled-icon-button>

                <!-- Upload/download button group spacer -->
                <div style$=width:20px;"></div>

                <!-- Document count -->
                <iron-label
                        id="documentCount"
                        hidden$="[[!showDocumentCount]]"
                        style="font-family:Arial; font-size:14pt; ">
                    [[documentCount]]
                </iron-label>

                <div class="flex"></div>
                <div style="width:25px;"></div>

                <!-- Details button -->
                <!--<ft-labeled-icon-button-->
                        <!--id="detailsButton"-->
                        <!--icon="info-outline"-->
                        <!--label="Details"-->
                        <!--disabled="[[!_haveSelection]]"-->
                        <!--on-tap="_onShowDetailsButtonClicked">-->
                <!--</ft-labeled-icon-button>-->
            </div>

            <!-- Views -->
            <iron-pages
                    id="views"
                    style="width:100%; height:100%; background-color:white; "
                    attr-for-selected="id"
                    selected="[[selectedView]]">

                <!-- Grid -->
                <div
                        id="grid"
                        style="overflow:auto;">
                    <ft-document-grid
                            id="documentGrid"
                            documents="[[documents]]"
                            selected-document="{{selectedDocument}}">
                    </ft-document-grid>
                </div>

                <!-- List -->
                <div
                        id="list"
                        style="overflow:auto">
                    <ft-document-list
                            id="documentList"
                            style="border-bottom:1px solid #DDD"
                            documents="[[documents]]"
                            selected-document="{{selectedDocument}}">
                    </ft-document-list>
                </div>

                <!-- Preview -->
                <div
                        id="preview"
                        class="layout vertical center"
                        style="width:100%; height:100%">

                    <div style="height:100px;"></div>

                    <iron-label style="font-size:24pt">
                        Document preview is coming soon
                    </iron-label>

                    <div style="height:100px;"></div>
                </div>

            </iron-pages>

        </div>

        <!-- Confirmation dialog -->
        <ft-confirmation-dialog id="confirmationDialog"></ft-confirmation-dialog>

    </template>

    <script>
        Polymer({

            is: 'ft-document-panel',

            behaviors: [
                Polymer.IronResizableBehavior,
                FtScrollingBehavior
            ],

            /**
             * Fired when the "Download" button is clicked.
             *
             * @event download
             * @param {Object} document The selected document whose file the user wants to download.
             */

            /**
             * Fired when the "Upload" button is clicked.
             *
             * @event upload
             */

            /**
             * Fired when the "Delete" button is clicked.
             *
             * @event delete
             * @param {Object} document The selected document to be deleted.
             */

            /**
             * Fired when the "Show Details" button is clicked.
             *
             * @event show-details
             */

            properties: {

                /** The list of documents resources to be displayed. */
                documents:
                {
                    type: Array,
                    notify: true,
                    value: [],
                    observer: "_documentsChanged"
                },

                /** The currently-selected document, if any. */
                selectedDocument:
                {
                    type: Object,
                    notify: true,
                    value: null,
                    observer: "_selectedDocumentChanged"
                },

                /** The total number of documents. */
                documentCount:
                {
                    type: Number,
                    notify: true,
                    value: 0
                },

                /** Show a title string. */
                showTitle:
                {
                    type: Boolean,
                    value: true,
                    observer: "_showButtonChanged"
                },

                /** Title to display when "showTitle" is true. */
                title:
                {
                    type: String,
                    value: "Documents"
                },

                /** The currently-selected view of the document(s). Must be one of: "grid", "list", "preview". */
                selectedView:
                {
                    type: String,
                    notify: true,
                    value: "grid"
                },

                /** Show a button that lets users choose to view documents in a grid. */
                showGridButton:
                {
                    type: Boolean,
                    value: true,
                    observer: "_showButtonChanged"
                },

                /** Show a button that lets users choose to view documents in a list. */
                showListButton:
                {
                    type: Boolean,
                    value: true,
                    observer: "_showButtonChanged"
                },

                /** Show a button that lets users choose to preview the selected document. */
                showPreviewButton:
                {
                    type: Boolean,
                    value: true,
                    observer: "_showButtonChanged"
                },

                /** Show a button that lets users upload document files. */
                showUploadButton:
                {
                    type: Boolean,
                    value: true,
                    observer: "_showButtonChanged"
                },

                /** Show a button that lets users download file for the selected document. */
                showDownloadButton:
                {
                    type: Boolean,
                    value: true,
                    observer: "_showButtonChanged"
                },

                /** Show a button that lets users delete the selected document. */
                showDeleteButton:
                {
                    type: Boolean,
                    value: true,
                    observer: "_showButtonChanged"
                },

                /** Show count of documents. */
                showDocumentCount:
                {
                    type: Boolean,
                    value: true,
                    observer: "_showButtonChanged"
                },

                /** The FileThis ticket. Used for uploads. */
                ticket:
                {
                    type: String,
                    value: ""
                },

                _showButtonBar:
                {
                    type: Boolean,
                    value: true
                },

                _titleSpacerWidth:
                {
                    type: Number,
                    value: 30
                },

                _viewButtonGroupSpacerWidth:
                {
                    type: Number,
                    value: 30
                },

                _uploadDownloadButtonGroupSpacerWidth:
                {
                    type: Number,
                    value: 30
                },

                _haveSelection:
                {
                    type: Boolean,
                    value: false
                }
            },

            ready: function()
            {
                this._manageScroller(this.$.grid);
                this._manageScroller(this.$.list);
            },

            _calculateScrollerHeight: function(scroller)
            {
                const bar = this.$.buttonBar;
                const barIsHidden = (bar.offsetParent === null);
                var barHeight = 0;
                if (!barIsHidden)
                    barHeight = bar.offsetHeight;
                return this.clientHeight - barHeight;
            },


            _documentsChanged: function(to, from)
            {
                // Man, this is fugly...
                this._fixGrid();
//                this.$.documentGrid.fire('resize');
//                this.$.documentList.fire('resize');

                var documentCount = 0;
                if (!!this.documents)
                    documentCount = this.documents.length;
                this.documentCount = documentCount;
            },

            _fixGrid: function()
            {
                const currentSelectedViewId = this.selectedView;
                var tempSelectedViewId;
                if (currentSelectedViewId === "list")
                    tempSelectedViewId = "grid";
                else // currentSelectedViewId === "grid"
                    tempSelectedViewId = "list";
                this.selectedView = tempSelectedViewId;
                this.selectedView = currentSelectedViewId;
            },

            _selectedDocumentChanged: function(to, from)
            {
                this._haveSelection = (this.selectedDocument !== null);
            },

            _onViewAsListButtonClicked: function(event)
            {
                this.selectedView = "list";
            },

            _onViewAsGridButtonClicked: function(event)
            {
                this.selectedView = "grid";
            },

            _onPreviewButtonClicked: function(event)
            {
                this.selectedView = "preview";
            },

            _onDownloadButtonClicked: function(event)
            {
                this.fire('download', this.selectedDocument);
            },

            _onUploadButtonClicked: function(event)
            {
                this.fire('upload');
            },

            _onDeleteButtonClicked: function(event)
            {
                const overrideWarning = event.metaKey;
                if (overrideWarning)
                {
                    this.fire('delete', this.selectedDocument);
                    return;
                }

                const prompt = "Are you sure you want to delete the selected document?";
                return this.$.confirmationDialog.confirm(prompt, "Delete Document")
                    .then(function(choice)
                    {
                        if (choice === "cancel")
                            return;
                        this.fire('delete', this.selectedDocument);
                    }.bind(this))
            },

            _onShowDetailsButtonClicked: function(event)
            {
                this.fire('show-details');
            },

            _showButtonChanged: function(to, from)
            {
                this._showButtonBar = this._canShowButtonBar();
                this._respaceButtons();
                this.notifyResize();
            },

            _canShowButtonBar: function()
            {
                if (this.showTitle)
                    return true;
                if (this._someViewButtonShown())
                    return true;
                if (this._someUploadDownloadButtonShown())
                    return true;
                if (this.showDeleteButton)
                    return true;
                if (this.showDocumentCount)
                    return true;
                return false;
            },

            _someViewButtonShown: function()
            {
                if (this.showGridButton)
                    return true;
                if (this.showListButton)
                    return true;
                if (this.showPreviewButton)
                    return true;
                return false;
            },

            _someUploadDownloadButtonShown: function()
            {
                if (this.showUploadButton)
                    return true;
                if (this.showDownloadButton)
                    return true;
                return false;
            },

            _respaceButtons: function()
            {
                const groupSpacerWidth = 30;

                var titleSpacerWidth = 0;
                var viewButtonGroupSpacerWidth = 0;
                var uploadDownloadButtonGroupSpacerWidth = 0;

                if (this.showTitle)
                    titleSpacerWidth = groupSpacerWidth;
                if (this._someViewButtonShown())
                    viewButtonGroupSpacerWidth = groupSpacerWidth;
                if (this._someUploadDownloadButtonShown())
                    uploadDownloadButtonGroupSpacerWidth = groupSpacerWidth;

                this._titleSpacerWidth = titleSpacerWidth;
                this._viewButtonGroupSpacerWidth = viewButtonGroupSpacerWidth;
                this._uploadDownloadButtonGroupSpacerWidth = uploadDownloadButtonGroupSpacerWidth;
            }

        });
    </script>
</dom-module>
